# An√°lisis de Seguridad y Escalabilidad - QR Restaurant Platform

**Fecha:** Enero 2025
**Objetivo:** Escalar de 1 restaurante a 1000+ restaurantes con seguridad enterprise

---

## üö® VULNERABILIDADES CR√çTICAS ACTUALES

### 1. **SECRETOS EXPUESTOS EN C√ìDIGO**
**Severidad: CR√çTICA üî¥**

```yaml
# docker-compose.ssl.yml - L√çNEA 12, 14-16
DATABASE_URL=postgresql://qr_admin:%231999Stri@31.220.31.19:5432/qrrestaurant
NEXTAUTH_SECRET=development-secret-32-chars-long
STRIPE_SECRET_KEY=sk_test_51Rw6JgCKa9K8LC0J...
```

**Problema:**
- Contrase√±as de base de datos hardcodeadas
- Claves de Stripe visibles en repositorio
- Si alguien accede a tu GitHub, puede:
  - Acceder a tu base de datos completa
  - Robar informaci√≥n de pagos
  - Modificar √≥rdenes y precios

**Soluci√≥n Inmediata:**
1. Usar archivos `.env` que NO est√©n en Git
2. Rotar todas las credenciales expuestas
3. Implementar secrets manager (AWS Secrets Manager, HashiCorp Vault)

---

### 2. **LOGS CON INFORMACI√ìN SENSIBLE**
**Severidad: ALTA üü†**

```typescript
// src/lib/auth.ts - L√çNEAS 60-63
console.log("üîë Password comparison:", {
  inputPassword: credentials.password,  // ‚ùå PASSWORD EN LOGS
  isValid: isPasswordValid
})
```

**Problema:**
- Passwords aparecen en logs de Docker
- Cualquiera con acceso al servidor puede ver contrase√±as
- Logs se pueden enviar a servicios de monitoreo (exponen passwords)

**Soluci√≥n:**
- NUNCA loguear passwords
- Solo loguear eventos sin datos sensibles

---

### 3. **SIN RATE LIMITING**
**Severidad: CR√çTICA üî¥**

**Problema:**
- Cualquiera puede hacer 1000+ requests por segundo
- Permite ataques de fuerza bruta al login
- Permite DDoS f√°cilmente
- Sin rate limiting, un atacante puede:
  - Probar millones de passwords en minutos
  - Saturar tu servidor gratis
  - Crear miles de restaurantes fake

**Soluci√≥n:**
- Implementar rate limiting por IP
- Limitar intentos de login (5 intentos m√°ximo)
- Usar CAPTCHA despu√©s de 3 intentos fallidos

---

### 4. **DEVICE ID NO FUNCIONA CORRECTAMENTE**
**Severidad: MEDIA üü°**

```typescript
// El deviceId se genera pero no se persiste correctamente
deviceId      String?     // For tracking orders by device
```

**Problema:**
- No hay modelo de Customer/User
- deviceId se genera cada sesi√≥n (no persiste)
- No se puede rastrear historial de clientes
- Imposible implementar reviews o loyalty programs

**Soluci√≥n:**
- Crear modelo Customer con deviceId √∫nico
- Implementar fingerprinting del navegador
- Agregar login opcional para clientes

---

### 5. **SIN SEPARACI√ìN DE ROLES**
**Severidad: ALTA üü†**

**Problema:**
- Solo existe el rol "Restaurant Owner"
- No hay roles para:
  - Chef/Cocina (ver √≥rdenes, cambiar status)
  - Mesero (tomar √≥rdenes, servir)
  - Manager (analytics, no puede editar men√∫)
  - Super Admin (gestionar m√∫ltiples restaurantes)

**Soluci√≥n Inmediata:**
- Crear modelo `User` separado de `Restaurant`
- Agregar campo `role: OWNER | CHEF | WAITER | MANAGER`
- Implementar permisos por rol

---

### 6. **BASE DE DATOS EXPUESTA A INTERNET**
**Severidad: CR√çTICA üî¥**

```yaml
DATABASE_URL=postgresql://qr_admin:%231999Stri@31.220.31.19:5432/qrrestaurant
# ‚ö†Ô∏è IP p√∫blica: 31.220.31.19
```

**Problema:**
- Base de datos PostgreSQL escuchando en IP p√∫blica
- Cualquiera puede intentar conectarse
- Alta probabilidad de ataques automatizados

**Soluci√≥n:**
- Mover DB a red privada
- Solo permitir conexiones desde el servidor de aplicaci√≥n
- Usar VPN o t√∫nel SSH si necesitas acceso externo
- Configurar firewall (solo puerto 5432 desde IPs espec√≠ficas)

---

### 7. **SIN AUTENTICACI√ìN EN ENDPOINTS P√öBLICOS**
**Severidad: MEDIA üü°**

```typescript
// Endpoints sin auth que podr√≠an abusarse:
// - POST /api/orders (crear √≥rdenes falsas)
// - GET /api/public/menu/:id (scraping de men√∫s)
```

**Problema:**
- Cualquiera puede crear √≥rdenes sin pagar
- Competencia puede robar tu men√∫ completo
- Bots pueden saturar con √≥rdenes falsas

**Soluci√≥n:**
- Implementar tokens temporales por mesa (QR codes firmados)
- Rate limiting agresivo en endpoints p√∫blicos
- CAPTCHA en creaci√≥n de √≥rdenes

---

## üìä PROBLEMAS DE ESCALABILIDAD

### 1. **ARQUITECTURA ACTUAL**

```
[Cliente] ‚Üí [Nginx:8443] ‚Üí [Next.js Container] ‚Üí [PostgreSQL P√∫blico]
                              ‚Üì
                         [Stripe API]
```

**L√≠mites actuales:**
- **1 servidor**: Si se cae, TODO se cae
- **1 contenedor Next.js**: M√°ximo ~100-200 requests/segundo
- **1 base de datos**: Cuello de botella en ~1000 √≥rdenes/segundo
- **Sin cach√©**: Cada request golpea la DB

**Capacidad estimada:**
- **M√°ximo:** 50-100 restaurantes activos simult√°neos
- **Peak orders:** ~500 √≥rdenes/hora antes de degradaci√≥n

---

### 2. **ARQUITECTURA PARA 1000 RESTAURANTES**

```
                    [CloudFlare CDN]
                           ‚Üì
                    [Load Balancer]
                     /     |      \
              [App1] [App2] [App3] ... [App-N]
                \      |      /
                 [Redis Cache]
                       ‚Üì
           [PostgreSQL Primary (Write)]
              /       |        \
         [Replica1] [Replica2] [Replica3]
              \       |        /
               [Read Queries]
```

**Componentes necesarios:**

#### A. **Load Balancer (Nginx/HAProxy)**
- Distribuir tr√°fico entre m√∫ltiples servidores
- Health checks autom√°ticos
- SSL termination

#### B. **M√∫ltiples Instancias de App**
- Docker Swarm o Kubernetes
- Auto-scaling basado en CPU/memoria
- 3-5 instancias m√≠nimo para alta disponibilidad

#### C. **Redis Cache Layer**
- Cachear men√∫s (rara vez cambian)
- Cachear analytics (actualizar cada 5min)
- Sessions store
- Rate limiting storage

#### D. **PostgreSQL con Read Replicas**
- Master: Solo escrituras (√≥rdenes, pagos)
- 2-3 Replicas: Solo lecturas (men√∫s, analytics)
- Sharding por restaurantId despu√©s de 5000 restaurantes

#### E. **Object Storage (S3/CloudFlare R2)**
- Im√°genes de men√∫
- QR codes
- Logos de restaurantes
- No almacenar en servidor

#### F. **Queue System (RabbitMQ/Redis)**
- Procesar √≥rdenes as√≠ncronamente
- Enviar notificaciones
- Generar reportes

---

### 3. **PERFORMANCE OPTIMIZATIONS**

#### **Caching Strategy**

```typescript
// Cachear men√∫s por 5 minutos
const menu = await redis.get(`menu:${restaurantId}`)
if (!menu) {
  menu = await prisma.menuItem.findMany(...)
  await redis.setex(`menu:${restaurantId}`, 300, JSON.stringify(menu))
}
```

**Qu√© cachear:**
- Men√∫s completos: 5-10 minutos
- Analytics diarias: 5 minutos
- Restaurant info: 30 minutos
- QR codes: 24 horas

**No cachear:**
- √ìrdenes en tiempo real
- Payment status
- Stock/availability real-time

#### **Database Indexing**

```sql
-- √çndices cr√≠ticos faltantes:
CREATE INDEX idx_orders_restaurant_created ON "Order"(restaurantId, createdAt DESC);
CREATE INDEX idx_orders_status ON "Order"(status);
CREATE INDEX idx_orders_device ON "Order"(deviceId);
CREATE INDEX idx_menu_restaurant ON "MenuItem"(restaurantId, available);
```

#### **Connection Pooling**

```typescript
// Prisma actual: Sin pool configurado
// Necesitas:
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Configurar pool
  connectionLimit = 20
  poolTimeout = 30
}
```

---

## üèóÔ∏è NUEVAS FUNCIONALIDADES REQUERIDAS

### 1. **SISTEMA DE ROLES Y PERMISOS**

```typescript
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  role         Role     @default(STAFF)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  permissions  Json?    // Permisos granulares
  createdAt    DateTime @default(now())
}

enum Role {
  SUPER_ADMIN  // Gestiona m√∫ltiples restaurantes
  OWNER        // Due√±o del restaurante
  MANAGER      // Gestiona operaciones
  CHEF         // Solo cocina
  WAITER       // Solo √≥rdenes
  CASHIER      // Solo pagos
}
```

**Permisos por rol:**

| Permiso | OWNER | MANAGER | CHEF | WAITER | CASHIER |
|---------|-------|---------|------|--------|---------|
| Ver men√∫ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Editar men√∫ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Ver √≥rdenes | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Cambiar status | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Ver analytics | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Gestionar pagos | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ |

---

### 2. **DASHBOARD DE COCINA**

```typescript
// Nueva ruta: /kitchen
// Permisos: CHEF, MANAGER, OWNER

interface KitchenView {
  // Vista optimizada para tablet en cocina
  - √ìrdenes pendientes (CONFIRMED, PREPARING)
  - Timer por orden (tiempo desde creaci√≥n)
  - Botones grandes: "Empezar" "Listo"
  - Agrupaci√≥n por categor√≠a (Entradas, Platos, Postres)
  - Alertas sonoras para nuevas √≥rdenes
  - Sin informaci√≥n de pagos ni precios
}
```

**Features cr√≠ticos:**
- Auto-refresh cada 5 segundos
- Notificaciones push cuando llega nueva orden
- Vista de impresora t√©rmica (para imprimir tickets)
- Separaci√≥n por estaciones (cocina caliente, fr√≠a, bar)

---

### 3. **SISTEMA DE CLIENTES**

```typescript
model Customer {
  id              String    @id @default(cuid())
  deviceId        String    @unique  // Fingerprint del navegador
  email           String?   @unique  // Optional login
  phone           String?
  name            String?
  loyaltyPoints   Int       @default(0)
  createdAt       DateTime  @default(now())
  orders          Order[]
  reviews         Review[]
  favoriteItems   FavoriteItem[]
}

model Review {
  id           String   @id @default(cuid())
  customerId   String
  restaurantId String
  orderId      String   @unique
  rating       Int      // 1-5 stars
  comment      String?
  response     String?  // Restaurant response
  createdAt    DateTime @default(now())
  customer     Customer @relation(fields: [customerId], references: [id])
}

model FavoriteItem {
  id         String   @id @default(cuid())
  customerId String
  menuItemId String
  customer   Customer @relation(fields: [customerId], references: [id])
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  @@unique([customerId, menuItemId])
}
```

**Device Fingerprinting mejorado:**

```typescript
// Generar deviceId √∫nico y persistente
import FingerprintJS from '@fingerprintjs/fingerprintjs'

const fp = await FingerprintJS.load()
const result = await fp.get()
const deviceId = result.visitorId // Persistente 99.5% del tiempo
```

---

### 4. **APP M√ìVIL (FUTURO)**

**Tecnolog√≠as recomendadas:**
- **React Native** + Expo (c√≥digo compartido con web)
- **Flutter** (mejor performance nativa)

**Features de la app:**
- Login opcional para clientes
- Historial de √≥rdenes
- Reordenar pedidos anteriores
- Programa de lealtad / puntos
- Reviews y ratings
- Notificaciones push (orden lista)
- Pago guardado

**Backend changes necesarios:**
- API REST/GraphQL limpia (separar de Next.js pages)
- JWT authentication para app
- Push notifications service (Firebase Cloud Messaging)

---

## üîê MEJORAS DE SEGURIDAD PRIORITARIAS

### **Fase 1: Urgente (Esta semana)**

1. **Mover secretos a .env**
```bash
# Crear .env (no commitear)
DATABASE_URL="..."
NEXTAUTH_SECRET="..."
STRIPE_SECRET_KEY="..."

# Agregar a .gitignore
.env
.env.local
.env.production
```

2. **Eliminar logs de passwords**
```typescript
// ELIMINAR estas l√≠neas de auth.ts
console.log("üîë Password comparison:", {
  inputPassword: credentials.password,  // ‚ùå ELIMINAR
  isValid: isPasswordValid
})
```

3. **Configurar firewall de base de datos**
```bash
# En servidor de DB
sudo ufw enable
sudo ufw allow from [IP_APP_SERVER] to any port 5432
sudo ufw deny 5432  # Bloquear todo lo dem√°s
```

4. **Rotar credenciales**
- Cambiar password de PostgreSQL
- Regenerar NEXTAUTH_SECRET
- Rotar claves de Stripe (contact support si ya est√° comprometido)

---

### **Fase 2: Corto plazo (2-4 semanas)**

1. **Implementar Rate Limiting**
```typescript
// npm install express-rate-limit
import rateLimit from 'express-rate-limit'

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 5, // 5 intentos
  message: 'Demasiados intentos de login, intenta en 15 minutos'
})

// Aplicar a /api/auth/*
```

2. **Agregar CSRF Protection**
```typescript
// Next.js tiene CSRF built-in, pero aseg√∫rate de:
// - Usar SameSite cookies
// - Validar origin headers
// - Tokens CSRF en forms
```

3. **Implementar roles y permisos**
```typescript
// Crear middleware de permisos
export function requireRole(roles: Role[]) {
  return async (req, res, next) => {
    const session = await getServerSession(authOptions)
    if (!session || !roles.includes(session.user.role)) {
      return res.status(403).json({ error: 'Forbidden' })
    }
    next()
  }
}
```

4. **Sanitizar inputs**
```typescript
// npm install validator
import validator from 'validator'

// Sanitizar TODOS los inputs de usuario
const cleanEmail = validator.normalizeEmail(email)
const cleanComment = validator.escape(comment)
```

---

### **Fase 3: Mediano plazo (1-3 meses)**

1. **Implementar Redis Cache**
2. **Setup CI/CD pipeline**
3. **Agregar monitoring (Sentry, DataDog)**
4. **Implementar backup autom√°tico de DB**
5. **Setup staging environment**
6. **Agregar tests automatizados**

---

## üí∞ COSTOS ESTIMADOS DE INFRAESTRUCTURA

### **Actual (1 restaurante):**
- **VPS:** $20-50/mes
- **Database:** Incluido en VPS
- **Total:** ~$50/mes

### **100 restaurantes:**
- **Load Balancer:** $20/mes (DigitalOcean)
- **App Servers (3x):** $40/mes cada = $120/mes
- **Database (managed):** $60/mes (DigitalOcean Postgres)
- **Redis:** $15/mes
- **S3/Object Storage:** $5-10/mes
- **Monitoring:** $50/mes (Sentry + logs)
- **Total:** ~$270/mes

### **1000 restaurantes:**
- **Load Balancer:** $50/mes (m√°s robusto)
- **App Servers (10x auto-scale):** $400/mes
- **Database cluster:** $200/mes (replicas + backup)
- **Redis cluster:** $100/mes
- **CDN (CloudFlare):** $20/mes
- **Object Storage:** $50/mes
- **Monitoring + Logs:** $200/mes
- **Total:** ~$1,020/mes

**Revenue model sugerido:**
- $50-100/mes por restaurante
- Con 1000 restaurantes = $50,000-100,000/mes
- Costo infraestructura = $1,020/mes (2% de revenue)
- Margen saludable de 98%

---

## üó∫Ô∏è ROADMAP T√âCNICO

### **Q1 2025: Fundaci√≥n s√≥lida**
- ‚úÖ Fix vulnerabilidades cr√≠ticas
- ‚úÖ Implementar rate limiting
- ‚úÖ Mover secrets a variables de entorno
- ‚úÖ Setup monitoring b√°sico
- ‚úÖ Implementar sistema de roles

### **Q2 2025: Escalabilidad**
- ‚¨ú Implementar Redis cache
- ‚¨ú Setup load balancer
- ‚¨ú Database read replicas
- ‚¨ú CI/CD pipeline
- ‚¨ú Automated backups

### **Q3 2025: Features avanzados**
- ‚¨ú Dashboard de cocina
- ‚¨ú Sistema de clientes robusto
- ‚¨ú Program de lealtad
- ‚¨ú Reviews y ratings
- ‚¨ú Analytics avanzados

### **Q4 2025: Mobile app**
- ‚¨ú API REST/GraphQL
- ‚¨ú React Native app (iOS + Android)
- ‚¨ú Push notifications
- ‚¨ú Offline mode
- ‚¨ú App Store launch

---

## üéØ PRIORIDADES INMEDIATAS (ESTA SEMANA)

1. **Mover secretos fuera del c√≥digo** ‚úÖ CR√çTICO
2. **Eliminar logs de passwords** ‚úÖ CR√çTICO
3. **Configurar firewall de DB** ‚úÖ CR√çTICO
4. **Implementar rate limiting en login** üî¥ ALTA
5. **Crear modelo de roles** üü† MEDIA

## üìö RECURSOS NECESARIOS

### **Servicios Cloud:**
- DigitalOcean / AWS / Google Cloud
- CloudFlare (CDN + DDoS protection)
- Redis Cloud o ElastiCache
- Managed PostgreSQL

### **Herramientas:**
- Sentry (error tracking)
- LogRocket o FullStory (session replay)
- DataDog o Grafana (monitoring)
- GitHub Actions (CI/CD)

### **Equipo (para escalar):**
- 1 DevOps engineer (gestionar infra)
- 1 Backend developer (optimizaciones)
- 1 Frontend developer (mobile app)
- 1 QA tester (testing automatizado)

---

## üîç CONCLUSI√ìN

Tu software est√° bien arquitectado para un MVP, pero tiene **7 vulnerabilidades cr√≠ticas** que deben arreglarse ANTES de escalar.

**Estado actual:**
- ‚úÖ Funciona bien para 1-10 restaurantes
- ‚ö†Ô∏è Vulnerable a ataques
- ‚ùå No escalable m√°s all√° de 50 restaurantes

**Despu√©s de fixes:**
- ‚úÖ Seguro para producci√≥n
- ‚úÖ Escalable a 1000+ restaurantes
- ‚úÖ Base s√≥lida para features avanzados

**Tiempo estimado:**
- Fixes de seguridad: 1 semana
- Implementar escalabilidad: 2-3 meses
- Mobile app: 3-4 meses

**¬øQuieres que empiece a implementar los fixes cr√≠ticos ahora?**
